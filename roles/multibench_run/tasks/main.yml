---
- name: Check if multibench host has the crucible binaries
  ansible.builtin.shell: >
    crucible help
  delegate_to: "{{ multibench_host }}"
  register: _multibench_run_binaries
  ignore_errors: true
  become: true

- name: Fail if the host is not setup properly
  ansible.builtin.fail:
    msg: "Host does not have crucible installed. Please run playbooks/multibench_setup_host.yml before using this role."
  when: _multibench_run_binaries.rc != 0

- name: Generate config file for multibench
  ansible.builtin.template:
    src: templates/config.ini.j2
    dest: "{{ multibench_script_dir }}/config.ini"
    mode: '0644'
  delegate_to: "{{ multibench_host }}"
  become: true

- name: Generate input json file for multibench run
  ansible.builtin.template:
    src: templates/all-in-one.json.j2
    dest: "{{ multibench_script_dir }}/all-in-one.json"
    mode: '0644'
  delegate_to: "{{ multibench_host }}"
  become: true
  when: multibench_uperf_num is not defined
  register: dest_json_file

- name: Generate input json file for multibench-uperf run
  ansible.builtin.template:
    src: templates/all-in-one-uperf.json.j2
    dest: "{{ multibench_script_dir }}/{{ num_uperf }}uperf-all-in-one.json"
    mode: '0644'
  delegate_to: "{{ multibench_host }}"
  become: true
  when: multibench_uperf_num is defined and multibench_uperf_num | int > 0
  register: dest_json_file

- name: Save multibench_input_json_file
  ansible.builtin.set_fact:
    multibench_input_json_file: "{{ dest_json_file.dest }}"
  when: dest_json_file is defined and dest_json_file.dest is defined

- name: Creating an output directory if needed
  when:
    - multibench_run_output_dir is undefined
    - multibench_run_output_dir.path is undefined
  block:
    - name: Create working directory
      ansible.builtin.tempfile:
        state: directory
        prefix: multibench
      register: _multibench_run_output

    - name: Set the new directory as multibench_run_output_dir
      ansible.builtin.set_fact:
        multibench_run_output_dir: _multibench_run_output

# Multibench needs to be run as root to properly access all settings files needed.
# The script launch a crucible cmd which start to build the container images used for the tests.
# Then, the infrastructure is deployed in a dedicated namespace called crucible-rickshaw.
# Once the tests are finished, the results are published in an OpenSearch DB and a summary is generated.
- name: Run and manage multibench workload
  block:
    - name: First try on launching multibench workload
      ansible.builtin.shell:
        cmd: >
          ./{{ multibench_script }} config.ini {{ multibench_input_json_file }}
        chdir: "{{ multibench_script_dir }}"
      delegate_to: "{{ multibench_host }}"
      become: true
      register: _multibench_run_results
      changed_when: _multibench_run_results.rc == 0

  rescue:
    - name: Delete the crucible-rickshaw namespace and its resources
      kubernetes.core.k8s:
        state: absent
        api: v1
        kind: Namespace
        name: crucible-rickshaw

    - name: Wait for namespace to be deleted
      kubernetes.core.k8s_info:
        api: v1
        kind: Namespace
        name: crucible-rickshaw
      register: _multibench_run_namespace_info
      until: _multibench_run_namespace_info.resources | length == 0
      retries: 20
      delay: 5

    - name: "Retry launching the multibench workload"
      ansible.builtin.shell:
        cmd: >
          ./{{ multibench_script }} config.ini
        chdir: "{{ multibench_script_dir }}"
      delegate_to: "{{ multibench_host }}"
      become: true
      register: _multibench_run_results
      changed_when: _multibench_run_results.rc == 0

- name: Retrieve summary results from Multibench VM
  vars:
    multibench_run_regex_file: >-
      {{ _multibench_run_results.stdout | regex_search('crucible/run/([^/\s]+)/run/result-summary', '\\1') | first }}
    multibench_run_filepath: "/var/lib/crucible/run/{{ multibench_run_regex_file }}/run/result-summary.txt"
  ansible.builtin.fetch:
    src: "{{ multibench_run_filepath }}"
    dest: "{{ multibench_run_output_dir.path }}/result-summary.txt"
    flat: true
  failed_when: false
  delegate_to: "{{ multibench_host }}"
  become: true

# Collect crucible metrics using primary period-id from result-summary and upload to DCI
- name: Collect crucible metrics using primary period-id from result-summary
  when: multibench_crucible_metric_collect | bool
  become: true
  delegate_to: "{{ multibench_host }}"
  block:

    - name: Extract all primary period-ids from result-summary
      ansible.builtin.shell: |
        set -e
        grep -E 'primary period-id:' "{{ multibench_run_output_dir.path }}/result-summary.txt" | sed -nE 's/.*primary period-id:[[:space:]]*([0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}).*/\1/p'
      register: _period_ids_result
                  
    - name: Set list of primary period-ids
      ansible.builtin.set_fact:
        _crucible_primary_period_ids: "{{ (_period_ids_result.stdout_lines | default([])) | map('trim') | select() | list }}"   

    - name: Run crucible get metric for each primary period and save to file on multibench host
      ansible.builtin.shell: |
        {% if ansible_loop.first %}
        echo "=== period-id: {{ item }} ===" > "{{ _crucible_metric_outfile }}"
        crucible get metric --period {{ item }} \
          --source {{ multibench_crucible_metric_source }} \
          --type "{{ multibench_crucible_metric_type }}" \
          --breakout "{{ multibench_crucible_metric_breakout }}" \
          >> "{{ _crucible_metric_outfile }}"
        {% else %}
        echo "" >> "{{ _crucible_metric_outfile }}"
        echo "=== period-id: {{ item }} ===" >> "{{ _crucible_metric_outfile }}"
        crucible get metric --period {{ item }} \
          --source {{ multibench_crucible_metric_source }} \
          --type "{{ multibench_crucible_metric_type }}" \
          --breakout "{{ multibench_crucible_metric_breakout }}" \
          >> "{{ _crucible_metric_outfile }}"
        {% endif %}
      vars:
        _crucible_metric_outfile: "/tmp/{{ multibench_crucible_metric_filename }}"
      loop: "{{ _crucible_primary_period_ids }}"
      loop_control:
        extended: true
        label: "{{ item }}"
      when: (_crucible_primary_period_ids | default([])) | length > 0

    - name: Fetch crucible metric output to multibench host
      ansible.builtin.fetch:
        src: "/tmp/{{ multibench_crucible_metric_filename }}"
        dest: "{{ multibench_run_output_dir.path }}/{{ multibench_crucible_metric_filename }}"
        flat: true      
      when: (_crucible_primary_period_ids | default([])) | length > 0

    - name: Copy crucible metric file to job_logs path
      ansible.builtin.copy:
        src: "{{ multibench_run_output_dir.path }}/{{ multibench_crucible_metric_filename }}"
        dest: "{{ job_logs.path }}/{{ multibench_crucible_metric_filename }}"
        mode: "0644"    
      when:
        - (_crucible_primary_period_ids | default([])) | length > 0
        - job_logs is defined
        - job_logs.path is defined
...
