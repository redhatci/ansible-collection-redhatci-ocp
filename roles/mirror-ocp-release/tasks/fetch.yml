---
- name: "Check if {{ uri | basename }} exists"
  stat:
    path: "{{ dir }}/{{ uri | basename }}"
    get_checksum: false
  register: target
  when:
    - not force  # we don't care to stat files if we're forcing

- name: "Fetch {{ uri | basename }}"
  get_url:
    url: "{{ uri }}"
    dest: "{{ dir }}"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    timeout: 1200
    setype: "{{ setype | default('httpd_sys_content_t') }}"
    checksum: "{{ checksum | default(omit) }}"
  become: true
  retries: 3
  delay: 10
  register: downloaded
  until: downloaded is not failed
  when:
    - force or not target.stat.exists

- name: "Apply new SELinux file context to file"
  command: /usr/sbin/restorecon -R "{{ dir }}/{{ uri | basename }}"
  become: true
...
