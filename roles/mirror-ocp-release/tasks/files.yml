---
- name: "Get release digest"
  shell: >
    set -o pipefail &&
    grep '^Digest:' {{ dir }}/release.txt
    | tr -s ' '
    | cut -d ' ' -f 2
  register: release_digest
  changed_when: false

- name: "Base64 encode binary signature"
  slurp:
    src: "{{ dir }}/signature-1"
  register: signature_b64
  changed_when: false
  no_log: true

# this file is used in the upgrade flow
- name: "Write release digest"
  copy:
    dest: "{{ dir }}/release.dig"
    content: "{{ release_digest.stdout }}"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    setype: httpd_sys_content_t
  become: true

- name: "Download and refresh channel upgrade graph"
  get_url:
    url: "https://api.openshift.com/api/upgrades_info/v1/graph?channel=fast-{{ major_version }}&arch=amd64"
    dest: "{{ cache_dir }}/graph-{{ major_version }}"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    timeout: 1200
    setype: "httpd_sys_content_t"
    headers:
      Accept: "application/json"
  become: true
  retries: 3
  delay: 10
  register: downloaded
  until: downloaded is not failed

- name: "Write mirrored image content source policy"
  copy:
    dest: "{{ dir }}/imagecontentsourcepolicy.yaml"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    setype: httpd_sys_content_t
    content: |
      apiVersion: operator.openshift.io/v1alpha1
      kind: ImageContentSourcePolicy
      metadata:
        name: release-{{ version }}
      spec:
        repositoryDigestMirrors:
        - mirrors:
          - {{ registry_url | urlsplit('netloc') }}{{ registry_url | urlsplit('path') }}
          source: quay.io/openshift-release-dev/ocp-release
        - mirrors:
          - {{ registry_url | urlsplit('netloc') }}{{ registry_url | urlsplit('path') }}
          source: quay.io/openshift-release-dev/ocp-v4.0-art-dev
        - mirrors:
          - {{ registry_url | urlsplit('netloc') }}{{ registry_url | urlsplit('path') }}
          source: registry.svc.ci.openshift.org/ocp/release
  become: true

- name: "Write signature config map"
  copy:
    dest: "{{ dir }}/signature.yaml"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    setype: httpd_sys_content_t
    content: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: signature-{{ version }}
        namespace: openshift-config-managed
        labels:
          release.openshift.io/verification-signatures: ""
      binaryData:
        {{ release_digest.stdout | replace(':', '-') }}-1 : {{ signature_b64.content }}
  become: true
...
