---
- name: Get OCP version
  ansible.builtin.set_fact:
    ocp_version: '{{ mor_version | regex_search("\d+\.\d+\.\d+") }}'

- name: Set extracted command
  ansible.builtin.set_fact:
    extracted_command: "{{ ocp_version is ansible.builtin.version('4.16.0', '>=') | ternary('openshift-install', 'openshift-baremetal-install') }}"

- name: "Check if installer has been extracted"
  ansible.builtin.stat:
    path: "{{ mor_cache_dir }}/{{ mor_version }}/{{ extracted_command }}"
    get_checksum: false
  register: target
  when:
    - not mor_force  # we don't care to stat files if we're forcing

- name: "Extract installer command from release image"
  ansible.builtin.command: >
    {{ mor_oc }} adm release extract
    --registry-config={{ mor_auths_file }}
    --command "{{ extracted_command }}"
    --from {{ mor_pull_url }}
    --to "{{ mor_cache_dir }}/{{ mor_version }}"
  register: extract_cmd
  until: extract_cmd is succeeded
  retries: 9
  delay: 10
  when:
    - mor_force or not target.stat.exists

- name: "Make installer command readable from HTTP"
  ansible.builtin.file:
    path: "{{ mor_cache_dir }}/{{ mor_version }}/{{ extracted_command }}"
    state: file
    owner: "{{ mor_owner }}"
    group: "{{ mor_group }}"
    mode: "0755"
    setype: "httpd_sys_content_t"
...
