- name: "DNM troubleshooting ABI install failures"
  ansible.builtin.fail:
    msg: "Stop here to run the install manually and troubleshoot: {{ manifests_dir }} - {{ agent_based_installer_path }} --log-level=debug agent wait-for bootstrap-complete"

- name: Wait for bootstrap complete
  ansible.builtin.shell:
    cmd: "{{ agent_based_installer_path }} --log-level=debug agent wait-for bootstrap-complete"
    chdir: "{{ manifests_dir }}"
  failed_when: false # Timeout is fixed and some bare metal clusters complete bootstrap just after the timeout

- name: Check installation and gather jobs if it fails
  block:
    - name: Wait for install complete - without retries
      ansible.builtin.command:
        cmd: "{{ agent_based_installer_path }} --log-level=debug agent wait-for install-complete"
        chdir: "{{ manifests_dir }}"
      when: not mabi_retry_install_complete_check|bool

    - name: Wait for install complete - with retries
      ansible.builtin.command:
        cmd: "{{ agent_based_installer_path }} --log-level=debug agent wait-for install-complete"
        chdir: "{{ manifests_dir }}"
      when: mabi_retry_install_complete_check|bool
      register: _mabi_install_output
      retries: 10
      delay: 60
      until:
        "'Attempted to gather ClusterOperator status after wait failure: Listing ClusterOperator objects' not in _mabi_install_output.stderr
        or
        'No events logged from the Agent Rest API' in _mabi_install_output.stderr"
  rescue:
    # Using master-0 IP address to reach the bootstrap VM
    # Placing the logs in repo_root_path
    # Trying several times in case there are SSH connectivity issues
    - name: Gather logs from installation
      vars:
        rendezvous_ip_address: "{{ hostvars[agent_based_installer_bootstrap_node][host_ip_keyword] }}"
      ansible.builtin.shell:
        cmd: "{{ agent_based_installer_path }} --log-level=debug gather bootstrap --bootstrap {{ rendezvous_ip_address }}"
        chdir: "{{ repo_root_path }}"
      register: command_result
      until: command_result.rc == 0
      retries: 6
      delay: 20
      failed_when: false

    - name: Fail properly because installation was not completed
      fail:
        msg: "Installation was not completed"
