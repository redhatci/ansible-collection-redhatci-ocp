---
- name: Check if ArgoCD App exists
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1beta1
    kind: Application
    name: "{{ ac_app_name }}"
    namespace: "{{ ac_namespace }}"
  register: _ac_app_status

- name: Delete ArgoCD App if it exists
  when:
    - _ac_app_status.resources | length > 0
  block:
    - name: Print ArgoCD App to delete
      ansible.builtin.debug:
        msg: "Deleting ArgoCD App: {{ _ac_app_status.resources[0].metadata.name }}"

    - name: Patch ArgoCD without finalizers (non-cascade)
      when:
        - ac_action == 'delete'
      kubernetes.core.k8s:
        api_version: argoproj.io/v1beta1
        kind: Application
        name: "{{ ac_app_name }}"
        namespace: "{{ ac_namespace }}"
        definition:
          metadata:
            finalizers: null

    - name: Patch ArgoCD with finalizers (cascade)
      when:
        - ac_action == 'delete-cascade'
      kubernetes.core.k8s:
        api_version: argoproj.io/v1beta1
        kind: Application
        name: "{{ ac_app_name }}"
        namespace: "{{ ac_namespace }}"
        definition:
          metadata:
            finalizers:
              - "resources-finalizer.argocd.argoproj.io"

    - name: Delete ArgoCD App
      kubernetes.core.k8s:
        state: absent
        api_version: argoproj.io/v1beta1
        kind: Application
        name: "{{ ac_app_name }}"
        namespace: "{{ ac_namespace }}"

    - name: Wait for ArgoCD App deletion
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1beta1
        kind: Application
        name: "{{ ac_app_name }}"
        namespace: "{{ ac_namespace }}"
      register: _ac_app_status
      until: _ac_app_status.resources | length == 0
      retries: 120
      delay: 10
