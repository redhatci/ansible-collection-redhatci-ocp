- name: Build catalog
  shell:
    cmd: >
      set -x;
      {{ provision_cache_store }}/{{ version }}/oc adm catalog build
      --appregistry-org redhat-operators
      --from={{ opm_from_registry }}:v{{ base_version }}
      --filter-by-os="linux/amd64"
      --to={{ local_registry }}{{ opm_local_registry_path }}:v{{ base_version }}
      -a {{ dci_pullsecret_file }} --insecure

- name: Mirror catalog manifests
  shell:
    chdir: "{{ provision_cache_store }}/{{ version }}"
    cmd: >
      set -x;
      {{ provision_cache_store }}/{{ version }}/oc adm catalog mirror
      {{ local_registry }}{{ opm_local_registry_path }}:v{{ base_version }}
      {{ local_registry }} -a {{ dci_pullsecret_file }} --insecure
      --filter-by-os="linux/amd64" --manifests-only

- name: Copy Containers from mirror_list
  shell:
    cmd: >
      skopeo copy --authfile {{ dci_pullsecret_file }}
      --dest-tls-verify=false --all docker://{{ item.split('=')[0] }}
      docker://{{ item.split('=')[1] }}
  register: copy
  retries: 5
  delay: 5
  until:
    - copy is not failed
  loop: "{{ lookup('file', provision_cache_store + '/' + version + '/redhat-operators-manifests/mapping.txt').splitlines() }}"
  when:
    - item | regex_findall(mirror_list | join('|'))
