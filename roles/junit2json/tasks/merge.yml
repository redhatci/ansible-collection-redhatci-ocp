# SPDX-License-Identifier: Apache-2.0
---
# tasks file merge.yml for role redhatci.ocp.junit2json
# merges multiple XMLs into 1 and converts it into JSON

# Refer to this role [doc/dummy_variables.md](doc/dummy_variables.md) for more details
# Load and set dummy variables to prevent template evaluation errors in test data
- name: Load dummy variables configuration
  ansible.builtin.include_vars:
    file: dummy_variables.yml

- name: Merge custom dummy variables with defaults
  ansible.builtin.set_fact:
    junit2_dummy_variables: "{{ junit2_dummy_variables | combine(junit2_custom_dummy_variables, recursive=True) }}"
  when:
    - junit2_custom_dummy_variables | length > 0
    - junit2_dummy_variables | default({}) | length > 0

- name: Debug dummy variables being set
  ansible.builtin.debug:
    var: junit2_dummy_variables
  when:
    - junit2_dummy_debug | bool
    - junit2_dummy_variables | default({}) | length > 0

- name: Set dummy variables for template strings in test data
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ junit2_dummy_variables | default({}) | dict2items }}"
  when:
    - vars[item.key] is not defined
    - junit2_dummy_variables | default({}) | length > 0

- name: Ensure junit2_output_dir is created
  ansible.builtin.include_tasks:
    file: ensure-dir.yml
  loop:
    - "{{ junit2_output_dir }}"
  loop_control:
    loop_var: folder_path

- name: Merge multiple JSON report files into single consolidated report
  ansible.builtin.set_fact:
    junit2_result_merged_file: "{{ junit2_json_reports_list | redhatci.ocp.reportsmerger('/'.join([junit2_output_dir, junit2_output_merged_report])) }}"

- name: Debug merged file path
  ansible.builtin.debug:
    var: junit2_result_merged_file
