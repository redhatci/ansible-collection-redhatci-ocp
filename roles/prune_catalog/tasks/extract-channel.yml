---
- name: "Create optimized index for fast lookups"
  ansible.builtin.shell: |
    set -o pipefail

    # Create separate indexes by schema type for faster lookups
    jq 'select(.schema == "olm.package")' {{ pc_tmp_dir }}/index-packages > {{ pc_tmp_dir }}/packages.json
    jq 'select(.schema == "olm.channel")' {{ pc_tmp_dir }}/index-packages > {{ pc_tmp_dir }}/channels.json
    jq 'select(.schema == "olm.bundle")' {{ pc_tmp_dir }}/index-packages > {{ pc_tmp_dir }}/bundles.json

    # Create lookup tables for faster access
    jq -r '.name' {{ pc_tmp_dir }}/packages.json | sort > {{ pc_tmp_dir }}/package_names.txt
    jq -r '.package + ":" + .name' {{ pc_tmp_dir }}/channels.json | sort > {{ pc_tmp_dir }}/channel_lookup.txt
    jq -r '.package + ":" + .name' {{ pc_tmp_dir }}/bundles.json | sort > {{ pc_tmp_dir }}/bundle_lookup.txt
  register: _pc_index_result
  changed_when: _pc_index_result.rc == 0

- name: "Extract operators using pre-built indexes"
  ansible.builtin.shell: |
    set -o pipefail

    {% for operator in pc_operators %}
    # Fast lookup using grep on sorted index
    if grep -q "^{{ operator }}$" {{ pc_tmp_dir }}/package_names.txt; then
      jq --arg op "{{ operator }}" 'select(.name == $op)' {{ pc_tmp_dir }}/packages.json >> {{ pc_tmp_dir }}/configs/index.json
      jq --arg op "{{ operator }}" 'select(.package == $op)' {{ pc_tmp_dir }}/channels.json >> {{ pc_tmp_dir }}/configs/index.json
      jq --arg op "{{ operator }}" 'select(.package == $op)' {{ pc_tmp_dir }}/bundles.json >> {{ pc_tmp_dir }}/configs/index.json
    fi
    {% endfor %}
  register: _pc_extract_result
  changed_when: _pc_extract_result.rc == 0
...
