---
- name: "podman-setup : Check /proc/sys/user/max_user_namespaces is correct"
  lineinfile:
    path: /proc/sys/user/max_user_namespaces
    regexp: "^0"
    state: absent
  check_mode: yes
  changed_when: false
  register: out

- name: "podman-setup : Create /etc/sysctl.d/userns.conf"
  copy:
    content: |
      user.max_user_namespaces=28633
    dest: /etc/sysctl.d/userns.conf
  when: out.found

- name: "podman-setup : Update sysctl"
  command: sysctl -p /etc/sysctl.d/userns.conf
  when: out.found

- name: "podman-setup : Add subuid entry"
  lineinfile:
    path: /etc/subuid
    regexp: "^{{ ansible_user }}"
    line: "{{ ansible_user }}:100000:65536"
  notify:
  - "podman-setup : Run podman system migrate for main account"

- name: "podman-setup : Add additional subuid entries"
  lineinfile:
    path: /etc/subuid
    regexp: "^{{ item.split(':')[0] }}"
    line: "{{ item }}"
  with_items: "{{ podman_additional_subuids }}"
  register: additional_subuids_added
  notify:
  - "podman-setup : Run podman system migrate for additional uids"

- name: "podman-setup : Add subgid entry"
  lineinfile:
    path: /etc/subgid
    regexp: "^{{ ansible_user }}"
    line: "{{ ansible_user }}:100000:65536"

- name: "podman-setup : Add additional subgid entries"
  lineinfile:
    path: /etc/subgid
    regexp: "^{{ item.split(':')[0] }}"
    line: "{{ item }}"
  with_items: "{{ podman_additional_subgids }}"
...
