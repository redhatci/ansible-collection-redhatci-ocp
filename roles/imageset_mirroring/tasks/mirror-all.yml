---
- name: Validate im_operators is not empty
  ansible.builtin.assert:
    that:
      - im_operators is defined
      - im_operators | dict2items | length > 0
    fail_msg: "im_operators must contain at least one operator"

- name: Render ImageSetConfiguration for all versions of listed operators
  ansible.builtin.template:
    src: imagesetconfig-full.yaml.j2
    dest: "{{ _im_tmp_dir.path }}/imagesetconfig.yaml"
    mode: "0644"
  vars:
    _im_operators_with_catalog: >-
      {%- set result = [] -%}
      {%- for op_key, op_value in im_operators.items() -%}
        {%- set _ = result.append({
              'catalog': op_value.catalog | default(im_source_index),
              'operator': op_key
            })
        -%}
      {%- endfor -%}
      {{ result }}
    _im_catalogs_with_operators: >-
      {{ _im_operators_with_catalog | groupby('catalog') }}

- name: "Print ImageSetConfiguration content"
  ansible.builtin.debug:
    msg: "{{ lookup('file', _im_tmp_dir.path + '/imagesetconfig.yaml') }}"

- name: Mirror the operators
  vars:
    im_imageset_config_path: "{{ _im_tmp_dir.path }}/imagesetconfig.yaml"
  ansible.builtin.include_tasks: mirroring.yml
