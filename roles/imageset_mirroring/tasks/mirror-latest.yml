---
- name: Validate im_operators is not empty
  ansible.builtin.assert:
    that:
      - im_operators is defined
      - im_operators | dict2items | length > 0
    fail_msg: "im_operators must contain at least one operator"

- name: Setup auth config for oc-mirror
  when: im_auths_file is defined
  no_log: "{{ im_no_log }}"
  block:
    - name: Create auth config directory
      ansible.builtin.file:
        path: "{{ _im_tmp_dir.path }}/auth"
        state: directory
        mode: "0700"

    - name: Copy auth file to config.json
      ansible.builtin.copy:
        src: "{{ im_auths_file }}"
        dest: "{{ _im_tmp_dir.path }}/auth/config.json"
        mode: "0600"
        remote_src: true

- name: Get operator default channel and CSV
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      umask 0022
      {{ _im_tmp_dir.path }}/oc-mirror list operators \
        --catalog {{ item.value.catalog | default(im_source_index) }} \
        --package {{ item.key }} \
        2>/dev/null | \
      awk 'NR==2 {operator=$1; def_channel=$NF}
            /^PACKAGE/ {in_csv_section=1; next}
            in_csv_section && $2==def_channel {csv=$3}
            END {print operator, def_channel, csv}'
    executable: /bin/bash
  environment: "{{ {'DOCKER_CONFIG': _im_tmp_dir.path + '/auth'} if im_auths_file is defined else {} }}"
  register: _im_operator_info
  until: _im_operator_info.rc == 0
  retries: 3
  delay: 10
  loop: "{{ im_operators | dict2items }}"
  loop_control:
    label: "{{ item.key }} from {{ item.value.catalog | default(im_source_index) }}"
  changed_when: false

- name: Render ImageSetConfiguration for latest version of listed operators
  ansible.builtin.template:
    src: imagesetconfig-latest.yaml.j2
    dest: "{{ _im_tmp_dir.path }}/imagesetconfig.yaml"
    mode: "0644"
  vars:
    _im_operators_with_catalog: >-
      {%- set result = [] -%}
      {%- for item in _im_operator_info.results -%}
        {%- set _ = result.append({
              'catalog': item.item.value.catalog | default(im_source_index),
              'stdout': item.stdout,
              'operator': item.item.key
            })
        -%}
      {%- endfor -%}
      {{ result }}
    _im_catalogs_with_operators: >-
      {{ _im_operators_with_catalog | groupby('catalog') }}

- name: "Print ImageSetConfiguration content"
  ansible.builtin.debug:
    msg: "{{ lookup('file', _im_tmp_dir.path + '/imagesetconfig.yaml') }}"

- name: Mirror the operators
  vars:
    im_imageset_config_path: "{{ _im_tmp_dir.path }}/imagesetconfig.yaml"
  ansible.builtin.include_tasks: mirroring.yml
