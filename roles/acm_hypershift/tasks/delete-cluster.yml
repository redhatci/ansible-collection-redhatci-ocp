---
- name: Get Hosted Cluster info
  community.kubernetes.k8s_info:
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: "{{ ah_clusters_ns }}"
    name: "{{ ah_cluster_generated_name }}"
  register: hosted_cluster

- name: Delete cluster
  ansible.builtin.shell:
    cmd: >
      set -e;
      {{ ah_hcp_cli_path }} destroy cluster {{ ah_cluster_type }}
      --name={{ ah_cluster_generated_name }}
      --namespace={{ ah_clusters_ns }}
      --infra-id={{ ah_cluster_generated_name }}
  changed_when: false
  when:
    - hosted_cluster.resources | length == 1

- name: Wait for HCP to be deleted
  community.kubernetes.k8s_info:
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: "{{ ah_clusters_ns }}"
    name: "{{ ah_cluster_generated_name }}"
  retries: 10
  delay: 6
  register: _hosted_cluster
  until:
    - _hosted_cluster is defined
    - _hosted_cluster.resources is defined
    - _hosted_cluster.resources | length == 0
...
