---

- name: Set tnf_logs_location variable
  set_fact:
    tnf_logs_location: "{{ tnf_git_dir.path }}/{{ test_network_function_project_name }}/{{ test_network_function_project_name }}"

- name: Copy files that depends on the correct execution of CNF Cert Suite
  block:
    # claim.json file must be present if the execution finished correctly, else make the job to fail
    - name: Check the presence of claim.json
      stat:
        path: "{{ tnf_logs_location }}/claim.json"
      register: claim_json_present

    - name: CNF Cert Suite execution did not finish correctly
      fail:
        msg: claim.json file does not exist, so CNF Cert Suite execution did not finish correctly
      when: not claim_json_present.stat.exists|bool

    # If claim.json is present, we can assume the execution went fine, so we can continue copying files
    # This first task will upload claim.json and cnf-certification-tests_junit.xml
    - name: Copy XML and JSON files generated after CNF Cert Suite execution
      copy:
        src: "{{ item }}"
        dest: "{{ job_logs.path }}"
      with_fileglob:
        - "{{ tnf_logs_location }}/*.xml"
        - "{{ tnf_logs_location }}/*.json"

    # This is just for v4.3.0
    - name: Copy Javascript files generated by CNF Cert execution
      block:
        - name: set tnf_js_logs_location variable
          set_fact:
            tnf_js_logs_location: "{{ tnf_git_dir.path }}/{{ test_network_function_project_name }}/script"

        - name: Copy Javascript files in an auxiliary folder before compressing them with HTML report
          copy:
            src: "{{ item }}"
            dest: "{{ tnf_js_logs_location }}"
          with_fileglob:
            - "{{ tnf_logs_location }}/*.js"

        - name: Compress HTML results web page to upload it to DCI
          archive:
            path:
              - "{{ tnf_js_logs_location }}/classification.js"
              - "{{ tnf_js_logs_location }}/claimjson.js"
              - "{{ tnf_js_logs_location }}/results-embed.html"
              - "{{ tnf_js_logs_location }}/results.html"
            dest: "{{ job_logs.path }}/tnf-results-web-page.tar.gz"
      when: test_network_function_version is version("v4.3.0", "==")

    # This is just for HEAD version
    - name: Copy tar.gz report generated by CNF Cert execution
      block:
        # The name of this file is not always the same, we need to use with_fileglob
        - name: Copy tar.gz report in log folder
          copy:
            src: "{{ item }}"
            dest: "{{ job_logs.path }}"
          with_fileglob:
            - "{{ tnf_logs_location }}/*-cnf-test-results.tar.gz"
      when: test_network_function_version == "HEAD"
  always:
    # These files will always be present in the src folder, so we can safely copy them.
    - name: Copy dci-tnf-execution.log and tnf_config.yml in log folder
      copy:
        src: "{{ item }}"
        dest: "{{ job_logs.path }}"
      loop:
        - "{{ tnf_logs_location }}/dci-tnf-execution.log"
        - "{{ tnf_logs_location }}/tnf_config.yml"

...
