---

- name: Create temporary build directory
  tempfile:
    state: directory
  register: tnf_tempdir
  when: tnf_tempdir is not defined

- name: Get a list of pods
  k8s_info:
    api_version: v1
    kind: pod
    namespace: "{{ tnf_ns }}"
  register: tnf_pod_list

- name: Get a list of csv
  k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ tnf_ns }}"
  register: tnf_csv_list

- name: Get a list of pods from the tnf namespace to retrieve partner pod's metadata
  k8s_info:
    api_version: v1
    kind: pod
    namespace: tnf
  register: tnf_ns_partner_pod_list

- name: Check if test-network-function/tnf_config.yml file exists to decide the config file to be created
  ansible.builtin.stat:
    path: "{{ tnf_git_dir }}/test_network_function/test-network-function/tnf_config.yml"
  register: tnf_config_file

- name: Check if autodiscovering can be defined
  shell: |
    set -x
    grep -c targetPodLabels {{ tnf_git_dir }}/test_network_function/test-network-function/tnf_config.yml || :
  register: autodiscovering_enabled_output
  when: tnf_config_file.stat.exists

- name: Set autodiscovering_enabled variable
  set_fact:
    autodiscovering_enabled: "{% if tnf_config_file.stat.exists %}{{ autodiscovering_enabled_output.stdout }}{% else %}0{% endif %}"

- name: Template generic_test_configuration.yml
  template:
    src: templates/generic_test_configuration.yml.j2
    dest: "{{ tnf_tempdir.path }}/generic_test_configuration.yml"
  when: not tnf_config_file.stat.exists

- name: Template cnf_test_configuration.yml
  template:
    src: templates/cnf_test_configuration.yml.j2
    dest: "{{ tnf_tempdir.path }}/cnf_test_configuration.yml"
  when: not tnf_config_file.stat.exists

- name: Template tnf_config.yml
  template:
    src: templates/tnf_config.yml.j2
    dest: "{{ tnf_tempdir.path }}/tnf_config.yml"
  when: tnf_config_file.stat.exists

- name: Run the CNF Test Suite
  shell: |
    set -x
    if [ "{{ tnf_config_file.stat.exists }}" == "True" ]; then
      rm -f test-network-function/*.xml test-network-function/tnf_config.yml
      cp {{ tnf_tempdir.path }}/tnf_config.yml test-network-function/
    else
      rm -f test-network-function/*.xml test-network-function/generic_test_configuration.yml test-network-function/cnf_test_configuration.yml
      cp {{ tnf_tempdir.path }}/generic_test_configuration.yml {{ tnf_tempdir.path }}/cnf_test_configuration.yml test-network-function/
    fi

    if [ "{{ autodiscovering_enabled }}" != "0" ]; then
      export TNF_NON_INTRUSIVE_ONLY={{ tnf_non_intrusive_only }}
      export VERIFY_CNF_FEATURES={{ verify_cnf_features }}
      ./run-cnf-suites.sh -f {{ tnf_suites }} &> test-network-function/execution.log
    else
      ./run-cnf-suites.sh {{ tnf_suites }} &> test-network-function/execution.log
    fi
    cp test-network-function/*.xml {{ tnf_tempdir.path }}
    cp test-network-function/execution.log {{ tnf_tempdir.path }}
  args:
    chdir: "{{ tnf_git_dir }}/test_network_function"

...
