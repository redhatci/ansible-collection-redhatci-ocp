---
- name: Create temporary build directory
  tempfile:
    state: directory
  register: tnf_tempdir
  when: tnf_tempdir is not defined

- name: Template tnf_config.yml
  template:
    src: templates/tnf_config.yml.j2
    dest: "{{ tnf_git_dir.path }}/test-network-function/test-network-function/tnf_config.yml"

- name: Set tnf_partner_registry variable
  set_fact:
    tnf_partner_registry: "{{ ( provisionhost_registry|length ) | ternary(provisionhost_registry, 'quay.io') }}"

- name: Run the CNF Test Suite
  shell: |
    set -x

    rm -f test-network-function/*.xml

    export TNF_NON_INTRUSIVE_ONLY={{ tnf_non_intrusive_only }}
    export TNF_RUN_CFD_TEST={{ tnf_run_cfd_test }}
    export LOG_LEVEL={{ tnf_log_level }}
    export TNF_PARTNER_REPO={{ tnf_partner_registry }}/testnetworkfunction
    export TNF_IMAGE={{ tnf_image }}

    ./run-tnf-container.sh -k {{ kubeconfig_path }} \
    -i $TNF_IMAGE \
    -t {{ tnf_git_dir.path }}/test-network-function/test-network-function \
    -o {{ tnf_git_dir.path }}/test-network-function/test-network-function \
    -f {{ tnf_suites }} &> test-network-function/execution.log

    cp test-network-function/*.xml {{ tnf_tempdir.path }}
    cp test-network-function/*.json {{ tnf_tempdir.path }}
    cp test-network-function/execution.log {{ tnf_tempdir.path }}
    cp test-network-function/tnf_config.yml {{ tnf_tempdir.path }}
  args:
    chdir: "{{ tnf_git_dir.path }}/test-network-function"

...
