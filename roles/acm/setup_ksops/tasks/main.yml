- name: Verify SOPS age key is set
  ansible.builtin.assert:
    that:
      - sk_age_key is defined

- name: Load the SOPS age key into the cluster
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: sops-age
        namespace: openshift-gitops
      data:
        keys.txt: "{{ sk_age_key | b64encode }}"

- name: Patch the OpenShift GitOps ArgoCD resource
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1beta1
      kind: ArgoCD
      metadata:
        name: openshift-gitops
        namespace: openshift-gitops
      spec:
        kustomizeBuildOptions: --enable-alpha-plugins --enable-exec
        repo:
          env:
            - name: XDG_CONFIG_HOME
              value: /.config
            - name: SOPS_AGE_KEY_FILE
              value: /.config/sops/age/keys.txt
          volumes:
            - name: custom-tools
              emptyDir: {}
            - name: sops-age
              secret:
                secretName: sops-age
          initContainers:
            - name: install-ksops
              image: quay.io/viaductoss/ksops:v4.3.3
              command: ["/bin/sh", "-c"]
              args:
                - 'echo "Installing KSOPS..."; cp ksops /custom-tools/; cp $GOPATH/bin/kustomize /custom-tools/; echo "Done.";'
              volumeMounts:
                - mountPath: /custom-tools
                  name: custom-tools
          volumeMounts:
            - mountPath: /usr/local/bin/kustomize
              name: custom-tools
              subPath: kustomize
            - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
              name: custom-tools
              subPath: ksops
            - mountPath: /.config/sops/age/keys.txt
              name: sops-age
              subPath: keys.txt
