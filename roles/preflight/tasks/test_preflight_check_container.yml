---
# TODO: move to test_preflight_check_container_binary.yml?
- name: Set pyxis auth variable
  vars:
    pyxis_apikey: "{{ lookup('file', pyxis_apikey_path) }}"
  set_fact:
    pyxis_auth: >-
      --certification-project-id {{ operator.pyxis_identifier }}
      --pyxis-api-token {{ pyxis_apikey }}
  # Pyxis credentials are required only when running with --submit option.
  # TODO: fix the condition when Preflight would go with a release that does not require
  # a binary to run check container tests.
  when: preflight_binary | length > 0
  no_log: true

- name: "Run preflight check container on operator images for {{ operator.name }} with podman"
  include_tasks: test_preflight_check_container_podman.yml
  loop: "{{ operator.operator_images }}"
  loop_control:
    loop_var: current_operator_image
  when: preflight_binary | length == 0

# Preflight 1.0.8 requires to use podman run.
# Preflight 1.2.0 requires to use binary because some container tests fail.
# The next Preflight release will require to use podman run again.
- name: "Run preflight check container on operator image for {{ operator.name }} with preflight binary"
  vars:
    pyxis_apikey: "{{ lookup('file', pyxis_apikey_path) }}"
  # TODO: to fix the usage of Preflight with --submit option
  include_tasks: test_preflight_check_container_binary.yml
  loop: "{{ operator.operator_images }}"
  loop_control:
    loop_var: current_operator_image
  when: preflight_binary | length > 0

...
