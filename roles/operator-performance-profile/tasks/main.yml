---
- name: Create namespace for Performance Addon operator
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        labels:
          openshift.io/cluster-monitoring: "true"
        name: openshift-performance-addon-operator
      spec: {}

- name: Create operatorgroup for Performance Addon operator
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: openshift-performance-addon-operatorgroup
        namespace: openshift-performance-addon-operator

- name: Create subscription for Performance Addon operator without channel
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: performance-addon-operator-subscription
        namespace: openshift-performance-addon-operator
      spec:
        name: performance-addon-operator
        source: "{{ opm_catalog_source_name }}"
        sourceNamespace: "{{ opm_catalog_source_namespace | default('openshift-marketplace') }}"
  when:
    - ocp_version_maj|int == 4
    - ocp_version_min|int >= 6

- name: Create subscription for Performance Addon operator with channel (4.5 and older)
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: performance-addon-operator-subscription
        namespace: openshift-performance-addon-operator
      spec:
        name: performance-addon-operator
        source: "{{ opm_catalog_source_name }}"
        sourceNamespace: "{{ opm_catalog_source_namespace | default('openshift-marketplace') }}"
        channel: "{{ ocp_version|string }}"
  when:
    - ocp_version_maj|int == 4
    - ocp_version_min|int <= 5

- name: test_ Check if performance-addon-operator csv is installed
  k8s_info:
    api: operators.coreos.com/v1alpha1
    namespace: openshift-performance-addon-operator
    kind: ClusterServiceVersion
  register: csv
  retries: 30
  delay: 5
  until:
    - "csv.resources|length == 1"
    - "'status' in csv.resources[0]"
    - "'phase' in csv.resources[0].status"
    - ("csv.resources[0].status.phase == 'Succeeded'" or "csv.resources[0].status.phase == 'Present'")

- name: Create PerformanceProfile
  k8s:
    definition: "{{ lookup('file', performance_definition | default('performance-profile-basic-' + ocp_version + '.yml')) }}"
  register: profile_state
  retries: 5
  delay: 60
  until: profile_state is not failed
  when:
    - enable_performance_profiling|default(true)|bool
    - install_type is undefined or install_type != 'sno'

- name: Pause for Machine Config to be created
  pause:
    seconds: 60
  when:
    - profile_state is defined
    - profile_state.changed | bool

- name: "Applying PAO profile for SNO nodes and Wait for node to be available"
  block:
    - name: "Wait for Performance Addon Operator endpoint to become available"
      pause:
        seconds: 60

    - name: "Create PerformanceProfile on SNO node"
      k8s:
        definition: "{{ lookup('file', performance_definition | default('performance-profile-sno.yml')) }}"
      register: sno_profile_state
      retries: 5
      delay: 60
      until: profile_state is not failed

    - name: "Pause 60 seconds to wait for PAO profile triggers SNO reboot"
      pause:
        seconds: 60
      when:
        - sno_profile_state is defined
        - sno_profile_state.changed | bool

    - name: "Wait for API to be available"
      uri:
        url: 'https://api.{{ cluster }}.{{ domain }}:6443/readyz'
        validate_certs: no
        return_content: yes
      register: api_ready
      until:
        - "'ok' in api_ready.content"
        - api_ready.status == 200
      retries: 15
      delay: 60

    - name: "Wait for SNO node to be in Ready state"
      k8s_info:
        api: v1
        kind: Node
      register: cluster_nodes
      until:
         - cluster_nodes.resources is defined
         - "'True' in cluster_nodes.resources[0].status.conditions | to_json | from_json | json_query(query)"
      vars:
        query: "[?contains(type, 'Ready')].status"
      retries: 90
      delay: 10
  when:
    - enable_performance_profiling|default(true)|bool
    - install_type is defined
    - install_type == "sno"

- name: Wait for updated machine configs to be applied on the nodes
  k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
  register: reg_mcpool_status
  vars:
    status_query: "resources[*].status.conditions[?type=='Updated'].status"
    update_status: "{{ reg_mcpool_status | json_query(status_query) | flatten | unique }}"
  until:
    - update_status == ['True']
  retries: 60
  delay: 60
...
